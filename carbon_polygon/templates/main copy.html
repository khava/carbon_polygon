{% extends 'base.html' %}

{% block content %}

    <div id="css"></div>
    <div id="scene"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.115.0/examples/js/renderers/CSS3DRenderer.js"></script>

    <script>
        let scene, camera, renderer, renderer2;

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x8EFF4E);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 1, 1000);
        camera.position.set(100, 800, 100);
        camera.lookAt(scene.position);


        renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMappingExposure = 2;
        document.querySelector('#scene').appendChild(renderer.domElement);


        renderer2 = new THREE.CSS3DRenderer();
        renderer2.setSize(window.innerWidth, window.innerHeight);
        renderer2.domElement.style.position = 'absolute';
        renderer2.domElement.style.top = '56px';
        renderer2.domElement.style.pointerEvents = 'none';
        document.querySelector('#css').appendChild(renderer2.domElement);


        window.addEventListener('resize', () => {
            renderer.setSize(window.innerWidth, window.innerHeight);
            camera.aspect = window.innerWidth/window.innerHeight;
        });


        let controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.update();


        let loader = new THREE.GLTFLoader();
        loader.load('../../static/3d_model/scene.glb', (gltf) => {
            let mroot = gltf.scene;
            let bbox = new THREE.Box3().setFromObject(mroot);
            let cent = bbox.getCenter(new THREE.Vector3());
            let size = bbox.getSize(new THREE.Vector3());

            //Rescale the object to normalized space
            let maxAxis = Math.max(size.x, size.y, size.z);
            mroot.scale.multiplyScalar(900.0 / maxAxis);
            bbox.setFromObject(mroot);
            bbox.getCenter(cent);
            bbox.getSize(size);

            //Reposition to 0,halfY,0
            mroot.position.copy(cent).multiplyScalar(-1);
            mroot.position.y-= (size.y * 0.5);

            // light
            let ambientLight = new THREE.AmbientLight( 0xFFFFFF, 0.3 );
            scene.add( ambientLight );

            let dirLight = new THREE.DirectionalLight( 0xFFFFFF, 0.8 );
            dirLight.position.set( 10, 4000, 100 );
            scene.add( dirLight );

            scene.add(gltf.scene);
            animate();
        })

        // buttons
        let button = makeElementObject('button', 29, -70, -172)
        button.css3dObject.element.style.borderRadius = '50%'
        button.css3dObject.element.style.backgroundColor = 'red'
        button.css3dObject.element.style.width = '90px'
        button.css3dObject.element.style.height = '90px'

        button.css3dObject.element.addEventListener('click', buttonAction)
        button.position.y = 10
    button.position.z = 10
        scene.add(button)

        function buttonAction() {
            alert('==========================')
        }


        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
            renderer2.render(scene, camera);
        }
        animate();

        function makeElementObject(type, x, y, z) {
            const obj = new THREE.Object3D

            let width = 9
            let height = 9

            const element = document.createElement(type);

            element.style.width = width+'px';
            element.style.height = height+'px';
            element.style.opacity = 0.999;
            element.style.background = new THREE.Color(
                Math.random() * 0.21568627451 + 0.462745098039,
                Math.random() * 0.21568627451 + 0.462745098039,
                Math.random() * 0.21568627451 + 0.462745098039,
            ).getStyle();

            let css3dObject = new THREE.CSS3DObject(element);
            obj.css3dObject = css3dObject
            obj.add(css3dObject)

            let material = new THREE.MeshPhongMaterial({
                opacity	: 0.15,
                color	: new THREE.Color(0xFF0000),
                blending: THREE.NoBlending,
                side	: THREE.DoubleSide,
            });
            let geometry = new THREE.CircleGeometry( width, height );
            geometry.rotateX(30)

            let mesh = new THREE.Mesh( geometry, material );
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            obj.lightShadowMesh = mesh
            obj.add( mesh );
            
            // obj.position.set(x, y, z)



            return obj
        }




        const geometry = new THREE.CircleGeometry( 90, 90 )
    const material = new THREE.MeshStandardMaterial({color:new THREE.Color(0xFF0000) });
    var option1 = new THREE.Mesh(geometry, material);
    option1.position.set( 6, 5, 1)
    scene.add(option1)

        var raycaster = new THREE.Raycaster();
        var mouse = new THREE.Vector2();

        function onMouseClick( event ) {
            raycaster.setFromCamera( mouse, camera );
            var isIntersected = raycaster.intersectObjects( scene.children );
            console.log(isIntersected)
            if (isIntersected) {
                console.log('Mesh clicked!')
            }
        }

        function onMouseMove( event ) {
            mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
            mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
        }

        window.addEventListener( 'click', onMouseClick, false );
        window.addEventListener( 'mousemove', onMouseMove, false );

    </script>
{% endblock %}